
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // Helper Functions

    /**
     * Checks if a user is authenticated.
     */
    function isSignedIn() {
      return request.auth != null;
    }

    /**
     * Checks if the currently authenticated user is a participant in a specific game session.
     * This looks at the existing data in Firestore, not the incoming request data.
     */
    function isPlayerInGame(gameSessionId) {
      let game = get(/databases/$(database)/documents/game_sessions/$(gameSessionId)).data;
      return isSignedIn() && request.auth.uid in game.players;
    }
    
    /**
     * Checks if the game session is in a 'waiting' state based on the data
     * already in Firestore.
     */
    function isGameWaiting(gameSessionId) {
      let game = get(/databases/$(database)/documents/game_sessions/$(gameSessionId)).data;
      return game.status == 'waiting';
    }

    /**
     * Checks if the currently authenticated user is the creator of the game session.
     */
    function isSessionCreator(gameSessionId) {
      let gameSession = get(/databases/$(database)/documents/game_sessions/$(gameSessionId)).data;
      return isSignedIn() && gameSession.creatorId == request.auth.uid;
    }

    match /decision_cards/{decisionCardId} {
      allow get, list: if true;
      allow create, update, delete: if false;
    }

    match /boss_encounters/{bossEncounterId} {
      allow get, list: if true;
      allow create, update, delete: if false;
    }

    /**
     * @description
     * Stores the metadata for each game session. 
     * - `get`, `list`: Allowed for any signed-in user (to find games).
     * - `create`: Allowed for any signed-in user.
     * - `update`: Allowed if the user is already a player OR if the game is in a 'waiting' state.
     *             This is the key rule that allows new players to join a lobby.
     * - `delete`: Restricted to the original creator of the game.
     */
    match /game_sessions/{gameSessionId} {
      allow get, list: if isSignedIn();
      allow create: if isSignedIn();
      // A user can update a session if they are already a player in it, OR if the game is still waiting for players.
      // This allows new players to join and existing players to make moves.
      allow update: if isPlayerInGame(gameSessionId) || isGameWaiting(gameSessionId);
      allow delete: if isSessionCreator(gameSessionId);
    }
  }
}

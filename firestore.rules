
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // Helper Functions

    /**
     * Checks if a user is authenticated.
     */
    function isSignedIn() {
      return request.auth != null;
    }

    /**
     * Checks if the currently authenticated user is a participant in a specific game session.
     * CRITICAL: This requires that the game_sessions/{gameSessionId} document contains
     * a map named 'players' where keys are the UIDs of the participants.
     * Example: { players: { "user_uid_1": "host", "user_uid_2": "player" } }
     */
    function isPlayerInGame(gameSessionId) {
      return isSignedIn() && request.auth.uid in get(/databases/$(database)/documents/game_sessions/$(gameSessionId)).data.players;
    }
    
    /**
     * Checks if the game session is in a 'waiting' state.
     * It checks the existing document in the database, not the incoming request data.
     */
    function isGameWaiting(gameSessionId) {
      let game = get(/databases/$(database)/documents/game_sessions/$(gameSessionId)).data;
      return game.status == 'waiting';
    }

    /**
     * Checks if the currently authenticated user is the creator of the game session.
     * CRITICAL: This requires that the game_sessions/{gameSessionId} document contains
     * a 'creatorId' field storing the UID of the user who created it.
     */
    function isSessionCreator(gameSessionId) {
      let gameSession = get(/databases/$(database)/documents/game_sessions/$(gameSessionId)).data;
      return isSignedIn() && gameSession.creatorId == request.auth.uid;
    }

    match /decision_cards/{decisionCardId} {
      allow get, list: if true;
      allow create, update, delete: if false;
    }

    match /boss_encounters/{bossEncounterId} {
      allow get, list: if true;
      allow create, update, delete: if false;
    }

    /**
     * @description
     * Stores the metadata for each game session. Allows signed-in users to list sessions
     * to join a game. Creation is allowed for any signed-in user.
     * Updates are more complex:
     * - Allowed if the user is already in the game (to make a move).
     * - Allowed if the game is in a 'waiting' state (to allow new players to join).
     * Deletion is restricted to the original creator.
     */
    match /game_sessions/{gameSessionId} {
      allow get, list: if isSignedIn();
      allow create: if isSignedIn();
      // A user can update a session if they are already a player in it, OR if the game is still waiting for players.
      allow update: if isPlayerInGame(gameSessionId) || isGameWaiting(gameSessionId);
      allow delete: if isSessionCreator(gameSessionId);
    }
  }
}
